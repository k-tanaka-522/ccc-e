#!/bin/bash
# ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåˆæœŸåŒ–ã‚¦ã‚£ã‚¶ãƒ¼ãƒ‰

echo "ğŸš€ ã‚¨ãƒ³ã‚¿ãƒ¼ãƒ—ãƒ©ã‚¤ã‚ºé–‹ç™ºãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåˆæœŸåŒ–"
echo "=================================="

# è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿
if [ -f "config/project/settings.conf" ]; then
    source config/project/settings.conf
fi

# ãƒ¢ãƒ¼ãƒ‰é¸æŠ
echo "å®Ÿè¡Œãƒ¢ãƒ¼ãƒ‰ã‚’é¸æŠã—ã¦ãã ã•ã„ï¼š"
echo "[1] ã‚¬ã‚¤ãƒ‰ãƒ¢ãƒ¼ãƒ‰ï¼ˆæ¨å¥¨ï¼‰- é †ç•ªã«è³ªå•ã«ç­”ãˆã¦ã„ã"
echo "[2] ãŠã¾ã‹ã›ãƒ¢ãƒ¼ãƒ‰ - AIãŒæ¥­ç•Œæ¨™æº–ã§è‡ªå‹•è¨­å®š"
read -p "é¸æŠ (1-2): " mode

# å‡ºåŠ›ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®ä½œæˆ
create_directories() {
    mkdir -p requirements architecture aws uiux
    mkdir -p logs tmp
}

# æ±ºå®šäº‹é …ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã®ç”Ÿæˆ
generate_index() {
    cat > requirements/index.md << 'EOF'
# ã“ã‚Œã‹ã‚‰æ±ºã‚ã‚‹ã“ã¨ãƒªã‚¹ãƒˆ

## 1. [ ] ãƒ“ã‚¸ãƒã‚¹è¦ä»¶
- ã‚µãƒ¼ãƒ“ã‚¹æ¦‚è¦
- ã‚¿ãƒ¼ã‚²ãƒƒãƒˆãƒ¦ãƒ¼ã‚¶ãƒ¼
- ä¸»è¦æ©Ÿèƒ½

## 2. [ ] æŠ€è¡“è¦ä»¶
- æƒ³å®šãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°
- å¯ç”¨æ€§ç›®æ¨™ï¼ˆSLOï¼‰
- ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚¿ã‚¤ãƒ è¦ä»¶

## 3. [ ] AWSæ§‹æˆ
- æ§‹æˆãƒ‘ã‚¿ãƒ¼ãƒ³é¸æŠ
- ã‚³ã‚¹ãƒˆä¸Šé™
- ãƒªãƒ¼ã‚¸ãƒ§ãƒ³é¸æŠ

## 4. [ ] é‹ç”¨è¦ä»¶
- ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—é »åº¦
- ç›£è¦–é …ç›®
- ã‚¢ãƒ©ãƒ¼ãƒˆè¨­å®š

## æ“ä½œãƒ¡ãƒ‹ãƒ¥ãƒ¼
- [S] ã‚¹ãƒ†ãƒƒãƒ—ãƒã‚¤ã‚¹ãƒ†ãƒƒãƒ—ã§é€²ã‚ã‚‹
- [A] AIã«ãŠã¾ã‹ã›ã§ä¸€æ‹¬è¨­å®š
- [Q] çµ‚äº†

EOF
}

# æ±ºå®šè¨˜éŒ²ã®åˆæœŸåŒ–
init_decision_log() {
    cat > requirements/decision_log.md << EOF
# æ±ºå®šäº‹é …è¨˜éŒ²

## ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæƒ…å ±
- **ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå**: ${PROJECT_NAME:-"æœªè¨­å®š"}
- **ä½œæˆæ—¥**: $(date -I)
- **æœ€çµ‚æ›´æ–°**: $(date -I)

## æ±ºå®šäº‹é …

### $(date -I) - ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåˆæœŸåŒ–
- ãƒ„ãƒ¼ãƒ«ã‚­ãƒƒãƒˆã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã—ãŸ
- åŸºæœ¬çš„ãªãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹é€ ã‚’ä½œæˆã—ã¾ã—ãŸ

EOF
}

# æ¥­ç•Œãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã®è¡¨ç¤º
show_industry_templates() {
    echo "ğŸ“‹ æ¥­ç•Œåˆ¥ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆï¼ˆå‚è€ƒï¼‰ï¼š"
    echo "1. ECã‚µã‚¤ãƒˆ - é«˜å¯ç”¨æ€§ã€æ±ºæ¸ˆã‚·ã‚¹ãƒ†ãƒ "
    echo "2. SaaS - ãƒãƒ«ãƒãƒ†ãƒŠãƒ³ãƒˆã€APIä¸­å¿ƒ"
    echo "3. ãƒ¡ãƒ‡ã‚£ã‚¢ - é«˜ãƒˆãƒ©ãƒ•ã‚£ãƒƒã‚¯ã€CDN"
    echo "4. ç¤¾å†…ã‚·ã‚¹ãƒ†ãƒ  - ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£é‡è¦–ã€å®‰å®šæ€§"
    echo "5. ã‚¹ã‚¿ãƒ¼ãƒˆã‚¢ãƒƒãƒ— - ä½ã‚³ã‚¹ãƒˆã€è¿…é€Ÿãƒ‡ãƒ—ãƒ­ã‚¤"
    echo "6. ãã®ä»– - ã‚«ã‚¹ã‚¿ãƒ è¨­å®š"
}

# SLOã‚ªãƒ—ã‚·ãƒ§ãƒ³ã®è¡¨ç¤º
show_slo_options() {
    echo "ğŸ“Š å¯ç”¨æ€§ç›®æ¨™ï¼ˆSLOï¼‰ï¼š"
    echo "1. 99.0%  - æœˆé–“7.2æ™‚é–“ãƒ€ã‚¦ãƒ³ï¼ˆé–‹ç™ºç’°å¢ƒï¼‰"
    echo "2. 99.9%  - æœˆé–“43åˆ†ãƒ€ã‚¦ãƒ³ï¼ˆæœ¬ç•ªç’°å¢ƒãƒ»æ¨™æº–ï¼‰"
    echo "3. 99.95% - æœˆé–“21åˆ†ãƒ€ã‚¦ãƒ³ï¼ˆé‡è¦ã‚·ã‚¹ãƒ†ãƒ ï¼‰"
    echo "4. 99.99% - æœˆé–“4åˆ†ãƒ€ã‚¦ãƒ³ï¼ˆãƒŸãƒƒã‚·ãƒ§ãƒ³ã‚¯ãƒªãƒ†ã‚£ã‚«ãƒ«ï¼‰"
}

# AWSæ§‹æˆãƒ‘ã‚¿ãƒ¼ãƒ³ã®è¡¨ç¤º
show_aws_patterns() {
    echo "â˜ï¸ AWSæ§‹æˆãƒ‘ã‚¿ãƒ¼ãƒ³ï¼š"
    echo "1. ã‚·ãƒ³ãƒ—ãƒ«æ§‹æˆ - EC2 + RDSï¼ˆä½ã‚³ã‚¹ãƒˆï¼‰"
    echo "2. ã‚³ãƒ³ãƒ†ãƒŠæ§‹æˆ - ECS + RDSï¼ˆã‚¹ã‚±ãƒ¼ãƒ©ãƒ–ãƒ«ï¼‰"
    echo "3. ã‚µãƒ¼ãƒãƒ¼ãƒ¬ã‚¹æ§‹æˆ - Lambda + DynamoDBï¼ˆé‹ç”¨ãƒ¬ã‚¹ï¼‰"
}

# SREã‚ªãƒ—ã‚·ãƒ§ãƒ³ã®è¡¨ç¤º
show_sre_options() {
    echo "ğŸ”§ é‹ç”¨ã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼š"
    echo "ç›£è¦–ãƒ¬ãƒ™ãƒ«ï¼š"
    echo "1. åŸºæœ¬ - CloudWatchæ¨™æº–ãƒ¡ãƒˆãƒªã‚¯ã‚¹"
    echo "2. æ¨™æº– - ã‚«ã‚¹ã‚¿ãƒ ãƒ¡ãƒˆãƒªã‚¯ã‚¹ + ã‚¢ãƒ©ãƒ¼ãƒˆ"
    echo "3. é«˜åº¦ - X-Ray + è©³ç´°ãƒ­ã‚° + PagerDuty"
}

# ã‚¬ã‚¤ãƒ‰ãƒ¢ãƒ¼ãƒ‰ã®å®Ÿè¡Œ
guide_mode() {
    echo ""
    echo "ğŸ“‹ ã‚¬ã‚¤ãƒ‰ãƒ¢ãƒ¼ãƒ‰é–‹å§‹"
    echo "==================="
    
    # ã‚¹ãƒ†ãƒƒãƒ—1: ãƒ“ã‚¸ãƒã‚¹è¦ä»¶
    echo ""
    echo "ğŸ“‹ ã‚¹ãƒ†ãƒƒãƒ—1/4: ãƒ“ã‚¸ãƒã‚¹è¦ä»¶"
    echo "========================="
    read -p "ã‚µãƒ¼ãƒ“ã‚¹å: " service_name
    read -p "ã‚µãƒ¼ãƒ“ã‚¹æ¦‚è¦ï¼ˆ1è¡Œã§ï¼‰: " service_desc
    
    show_industry_templates
    read -p "æ¥­ç•Œãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆé¸æŠ (1-6): " industry_template
    
    # ã‚¹ãƒ†ãƒƒãƒ—2: æŠ€è¡“è¦ä»¶
    echo ""
    echo "ğŸ“Š ã‚¹ãƒ†ãƒƒãƒ—2/4: æŠ€è¡“è¦ä»¶"
    echo "====================="
    read -p "æƒ³å®šãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°ï¼ˆåŒæ™‚æ¥ç¶šï¼‰: " user_count
    
    show_slo_options
    read -p "å¯ç”¨æ€§ç›®æ¨™é¸æŠ (1-4): " slo_choice
    
    read -p "ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚¿ã‚¤ãƒ è¦ä»¶ï¼ˆç§’ï¼‰: " response_time
    
    # ã‚¹ãƒ†ãƒƒãƒ—3: AWSæ§‹æˆ
    echo ""
    echo "â˜ï¸ ã‚¹ãƒ†ãƒƒãƒ—3/4: AWSæ§‹æˆ"
    echo "====================="
    show_aws_patterns
    read -p "æ§‹æˆãƒ‘ã‚¿ãƒ¼ãƒ³é¸æŠ (1-3): " aws_pattern
    
    read -p "æœˆé¡ã‚³ã‚¹ãƒˆä¸Šé™ï¼ˆUSDï¼‰: " cost_limit
    read -p "ãƒªãƒ¼ã‚¸ãƒ§ãƒ³ï¼ˆä¾‹ï¼šus-east-1ï¼‰: " region
    
    # ã‚¹ãƒ†ãƒƒãƒ—4: é‹ç”¨è¦ä»¶
    echo ""
    echo "ğŸ”§ ã‚¹ãƒ†ãƒƒãƒ—4/4: é‹ç”¨è¦ä»¶"
    echo "====================="
    show_sre_options
    read -p "ç›£è¦–ãƒ¬ãƒ™ãƒ«é¸æŠ (1-3): " monitoring_level
    
    read -p "ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—é »åº¦ï¼ˆæ—¥ï¼‰: " backup_frequency
    
    # è¦ä»¶å®šç¾©æ›¸ã®ç”Ÿæˆ
    generate_requirements_guide "$service_name" "$service_desc" "$industry_template" "$user_count" "$slo_choice" "$response_time" "$aws_pattern" "$cost_limit" "$region" "$monitoring_level" "$backup_frequency"
}

# ãŠã¾ã‹ã›ãƒ¢ãƒ¼ãƒ‰ã®å®Ÿè¡Œ
auto_mode() {
    echo ""
    echo "ğŸ¤– ãŠã¾ã‹ã›ãƒ¢ãƒ¼ãƒ‰é–‹å§‹"
    echo "==================="
    
    read -p "ä½œã‚ŠãŸã„ã‚µãƒ¼ãƒ“ã‚¹ã‚’ç°¡å˜ã«èª¬æ˜ã—ã¦ãã ã•ã„: " description
    
    echo "AIãŒè¦ä»¶ã‚’åˆ†æä¸­..."
    echo "ï¼ˆâ€» å®Ÿéš›ã®AIåˆ†æã¯ä»Šå¾Œå®Ÿè£…äºˆå®šï¼‰"
    
    # æ¥­ç•Œæ¨™æº–å€¤ã§è‡ªå‹•è¨­å®š
    generate_requirements_auto "$description"
}

# ã‚¬ã‚¤ãƒ‰ãƒ¢ãƒ¼ãƒ‰ç”¨è¦ä»¶å®šç¾©æ›¸ç”Ÿæˆ
generate_requirements_guide() {
    local service_name="$1"
    local service_desc="$2"
    local industry_template="$3"
    local user_count="$4"
    local slo_choice="$5"
    local response_time="$6"
    local aws_pattern="$7"
    local cost_limit="$8"
    local region="$9"
    local monitoring_level="${10}"
    local backup_frequency="${11}"
    
    # SLOå€¤ã®å¤‰æ›
    local slo_percent
    case "$slo_choice" in
        1) slo_percent="99.0%" ;;
        2) slo_percent="99.9%" ;;
        3) slo_percent="99.95%" ;;
        4) slo_percent="99.99%" ;;
        *) slo_percent="99.9%" ;;
    esac
    
    cat > requirements/requirements.md << EOF
# è¦ä»¶å®šç¾©æ›¸

## ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ¦‚è¦
- **ã‚µãƒ¼ãƒ“ã‚¹å**: ${service_name}
- **æ¦‚è¦**: ${service_desc}
- **ä½œæˆæ—¥**: $(date -I)

## ãƒ“ã‚¸ãƒã‚¹è¦ä»¶
- **æ¥­ç•Œåˆ†é¡**: ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ${industry_template}
- **æƒ³å®šãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°**: ${user_count}äººï¼ˆåŒæ™‚æ¥ç¶šï¼‰

## æŠ€è¡“è¦ä»¶
- **å¯ç”¨æ€§ç›®æ¨™**: ${slo_percent}
- **ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚¿ã‚¤ãƒ **: ${response_time}ç§’ä»¥å†…
- **ãƒªãƒ¼ã‚¸ãƒ§ãƒ³**: ${region}

## AWSæ§‹æˆ
- **æ§‹æˆãƒ‘ã‚¿ãƒ¼ãƒ³**: ãƒ‘ã‚¿ãƒ¼ãƒ³${aws_pattern}
- **ã‚³ã‚¹ãƒˆä¸Šé™**: ${cost_limit} USD/æœˆ

## é‹ç”¨è¦ä»¶
- **ç›£è¦–ãƒ¬ãƒ™ãƒ«**: ãƒ¬ãƒ™ãƒ«${monitoring_level}
- **ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—é »åº¦**: ${backup_frequency}æ—¥æ¯

## æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—
1. ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£è¨­è¨ˆ
2. CloudFormationãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆç”Ÿæˆ
3. ã‚³ã‚¹ãƒˆè¦‹ç©ã‚‚ã‚Š
4. å®Ÿè£…è¨ˆç”»ç­–å®š

EOF
}

# ãŠã¾ã‹ã›ãƒ¢ãƒ¼ãƒ‰ç”¨è¦ä»¶å®šç¾©æ›¸ç”Ÿæˆ
generate_requirements_auto() {
    local description="$1"
    
    cat > requirements/requirements.md << EOF
# è¦ä»¶å®šç¾©æ›¸ï¼ˆè‡ªå‹•ç”Ÿæˆï¼‰

## ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ¦‚è¦
- **ã‚µãƒ¼ãƒ“ã‚¹æ¦‚è¦**: ${description}
- **ä½œæˆæ—¥**: $(date -I)
- **ç”Ÿæˆæ–¹æ³•**: AIãŠã¾ã‹ã›ãƒ¢ãƒ¼ãƒ‰

## ãƒ“ã‚¸ãƒã‚¹è¦ä»¶ï¼ˆæ¨å®šï¼‰
- **æ¥­ç•Œåˆ†é¡**: è‡ªå‹•åˆ†æä¸­
- **æƒ³å®šãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°**: 1000äººï¼ˆåŒæ™‚æ¥ç¶šï¼‰

## æŠ€è¡“è¦ä»¶ï¼ˆæ¥­ç•Œæ¨™æº–ï¼‰
- **å¯ç”¨æ€§ç›®æ¨™**: 99.9%
- **ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚¿ã‚¤ãƒ **: 2ç§’ä»¥å†…
- **ãƒªãƒ¼ã‚¸ãƒ§ãƒ³**: us-east-1

## AWSæ§‹æˆï¼ˆæ¨å¥¨ï¼‰
- **æ§‹æˆãƒ‘ã‚¿ãƒ¼ãƒ³**: ã‚³ãƒ³ãƒ†ãƒŠæ§‹æˆï¼ˆECS + RDSï¼‰
- **ã‚³ã‚¹ãƒˆä¸Šé™**: 500 USD/æœˆ

## é‹ç”¨è¦ä»¶ï¼ˆæ¨™æº–ï¼‰
- **ç›£è¦–ãƒ¬ãƒ™ãƒ«**: æ¨™æº–ãƒ¬ãƒ™ãƒ«
- **ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—é »åº¦**: 1æ—¥æ¯

## èª¿æ•´ãŒå¿…è¦ãªé …ç›®
- [ ] è©³ç´°ãªãƒ“ã‚¸ãƒã‚¹è¦ä»¶ã®ç¢ºèª
- [ ] æŠ€è¡“è¦ä»¶ã®èª¿æ•´
- [ ] ã‚³ã‚¹ãƒˆè¦ä»¶ã®è¦‹ç›´ã—

EOF
}

# ãƒ¡ã‚¤ãƒ³å‡¦ç†
main() {
    echo "åˆæœŸåŒ–ã‚’é–‹å§‹ã—ã¾ã™..."
    
    # ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªä½œæˆ
    create_directories
    
    # åŸºæœ¬ãƒ•ã‚¡ã‚¤ãƒ«ç”Ÿæˆ
    generate_index
    init_decision_log
    
    echo "âœ… åŸºæœ¬ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—å®Œäº†"
    echo ""
    
    if [ "$mode" = "1" ]; then
        guide_mode
    elif [ "$mode" = "2" ]; then
        auto_mode
    else
        echo "âŒ ç„¡åŠ¹ãªé¸æŠã§ã™"
        exit 1
    fi
    
    echo ""
    echo "ğŸ‰ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåˆæœŸåŒ–å®Œäº†ï¼"
    echo ""
    echo "ğŸ“‹ ç”Ÿæˆã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ï¼š"
    echo "  - requirements/index.md          # ã“ã‚Œã‹ã‚‰æ±ºã‚ã‚‹ã“ã¨ãƒªã‚¹ãƒˆ"
    echo "  - requirements/decision_log.md   # æ±ºå®šäº‹é …è¨˜éŒ²"
    echo "  - requirements/requirements.md   # è¦ä»¶å®šç¾©æ›¸"
    echo ""
    echo "ğŸ“‹ æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ï¼š"
    echo "1. requirements/index.md ã‚’ç¢ºèª"
    echo "2. ä¸è¶³ã—ã¦ã„ã‚‹è¦ä»¶ãŒã‚ã‚Œã°è¿½åŠ "
    echo "3. agents/requirements/agent.sh ã§è©³ç´°åŒ–"
    echo "4. agents/architect/agent.sh ã§ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£è¨­è¨ˆ"
}

# å®Ÿè¡Œ
main